# AI Coding Companion Guide

- **Stack & Scope**: Supabase Edge Functions (Deno) orchestrating solar/water/HOA risk flows with Postgres + RLS; no external CRM. Core docs: [DEVELOPER_HANDOFF.md](DEVELOPER_HANDOFF.md), [OCR_PIPELINE_COMPLETE.md](OCR_PIPELINE_COMPLETE.md), [supabase/risk-registry.md](supabase/risk-registry.md).
- **Service Topology**: `vapi-handler` = inbound Vapi webhook that routes callers to agents and seeds leads; `vapi-mcp-server` = action router; proxies `water.lookup`→`adwr-lookup`, `hoa.query`→`hoa-rag`, `solar.lease.scan`→`solar-ocr-scanner`.
- **Data Model**: Tables `agents`, `leads`, `properties`, `risk_assessments`, `notes`, `tags`, `lead_tags`, `property_tags`, `hoa_documents`; enum `water_source_type`. Migrations live in [supabase/migrations](supabase/migrations); default tags seed in [supabase/sql/002_seed_risk_registry.sql](supabase/sql/002_seed_risk_registry.sql).
- **RLS/Identity**: All reads/writes scoped by `agent_id`; service role key is required inside functions. Client/anon tokens should respect RLS when testing curl examples.
- **vapi-handler behavior**: Incoming Vapi payloads must include `phoneNumberId`; missing mapping returns courteous fallback. When caller number is known it rehydrates lead context; inserts a lead otherwise; sends Discord webhook if configured. Solar keywords auto-create a lightweight `risk_assessments` row and inject a Spanglish “Solar Liability” prompt for the assistant. See [supabase/functions/vapi-handler/index.ts](supabase/functions/vapi-handler/index.ts) and local guide [TESTING.md](TESTING.md).
- **Orchestrator actions**: [supabase/functions/vapi-mcp-server/index.ts](supabase/functions/vapi-mcp-server/index.ts) handles `risk_assessment.create/latest`, `note.create`, `tags.ensure_and_attach`, plus proxy calls to the water/HOA/OCR functions. `lead`/`property` payloads auto-upsert if IDs missing.
- **Solar OCR microservice**: [supabase/functions/solar-ocr-scanner/index.ts](supabase/functions/solar-ocr-scanner/index.ts) fetches PDF/image (URL or base64), uses Google Document AI to extract monthly payment, escalator, buyout, transfer fee, term, contract type, vendor, and writes a `risk_assessments` record with risk level (high if escalator >2% or payment >300). Secrets needed: `GCP_PROJECT_ID`, `GCP_SOLAR_PROCESSOR_ID`, `GCP_LOCATION`, `GOOGLE_APPLICATION_CREDENTIALS_JSON`, plus `SUPABASE_URL`/`SUPABASE_SERVICE_ROLE_KEY`.
- **Water lookup**: [supabase/functions/adwr-lookup/index.ts](supabase/functions/adwr-lookup/index.ts) currently uses stubbed bounding boxes; production should swap to ADWR ArcGIS polygons and return `source_layer/confidence` (see gaps in [DEVELOPER_HANDOFF.md](DEVELOPER_HANDOFF.md)).
- **HOA RAG**: [supabase/functions/hoa-rag/index.ts](supabase/functions/hoa-rag/index.ts) provides rental restriction answers; KB stored in `hoa_documents`; embeddings/pgvector not yet wired.
- **Webhook utility**: [supabase/functions/vapi-mcp-server/vapi-webhook.js](supabase/functions/vapi-mcp-server/vapi-webhook.js) shows HMAC verification for Vapi payloads.
- **Seeding**: Use [real-estate-seed](real-estate-seed) package to populate tenants/leads/mappings. Copy `.env.example`→`.env`, set `SUPABASE_URL`/`SUPABASE_SERVICE_ROLE_KEY`, update `VAPI_PHONE_ID` in [real-estate-seed/seed.js](real-estate-seed/seed.js), run `npm run seed`.
- **Local Supabase DB**: `supabase start` then apply migrations: `supabase db reset` and execute the three SQL files in [supabase/migrations](supabase/migrations) plus [supabase/sql/002_seed_risk_registry.sql](supabase/sql/002_seed_risk_registry.sql).
- **Local function dev**: For orchestrator: `supabase start` then curl `http://127.0.0.1:54321/functions/v1/vapi-mcp-server` with an `action` payload. For OCR: same host hitting `/solar-ocr-scanner` with `document_base64` or `document_url`. For Vapi handler: `deno run --allow-all supabase/functions/vapi-handler/index.ts` (PowerShell) then `./test-handler.ps1`.
- **Deploy**: `npx supabase functions deploy vapi-mcp-server --no-verify-jwt` (and same for `solar-ocr-scanner`, `adwr-lookup`, `hoa-rag`); view logs with `npx supabase functions logs <name>`. Migrations: `npx supabase db push --include-all`.
- **Testing vectors**: Example curls for HOA/water/solar in [DEVELOPER_HANDOFF.md](DEVELOPER_HANDOFF.md) and [supabase/risk-registry.md](supabase/risk-registry.md); solar scenarios and expected outputs in [OCR_PIPELINE_COMPLETE.md](OCR_PIPELINE_COMPLETE.md).
- **Conventions**: Deno Edge runtime; prefer `json()` helpers for responses; HMAC verification optional for Vapi but enforced if `VAPI_WEBHOOK_SECRET` set; use service role for cross-function calls. Actions return `{ ok: true, ... }` or `{ error }` with HTTP 400/500 depending on failure.
- **Pitfalls/Gaps**: ADWR geofence stub only; OCR still Document AI (Azure migration desired); document URL allowlist/SSRF guard not yet enforced; auto-tagging on solar risk not implemented; solar scanner processes first page only. Keep these limitations in mind when adding features.
- **Personality prompt**: vapi-handler embeds Spanglish persona and solar/water advisory script—avoid changing tone unless explicitly requested.
- **Performance/limits**: OpenAI/GCP API rate limits apply; OCR call latency dominated by external API—add retries/backoff if making bulk jobs.
- **When adding actions**: mirror the switch pattern in `vapi-mcp-server`, validate required IDs early, and keep return shapes consistent with existing `{ ok, <payload> }` structure so downstream callers remain stable.
