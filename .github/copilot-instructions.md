# AI Coding Companion Guide

- **Stack & Scope**: Supabase Edge Functions (Deno) + Postgres with RLS for solar lease OCR, water lookup, HOA rental rules. Key refs: [DEVELOPER_HANDOFF.md](DEVELOPER_HANDOFF.md), [OCR_PIPELINE_COMPLETE.md](OCR_PIPELINE_COMPLETE.md), [GEMINI_OCR_MIGRATION.md](GEMINI_OCR_MIGRATION.md), [supabase/risk-registry.md](supabase/risk-registry.md).
- **Services**: `vapi-handler` (Vapi webhook → lead hydrate/insert, Spanglish persona, solar keyword detection); `vapi-mcp-server` (action router); proxies: `water.lookup`→`adwr-lookup`, `hoa.query`→`hoa-rag`, `solar.lease.scan`→`solar-ocr-scanner`.
- **Data Model**: `agents`, `leads`, `properties`, `risk_assessments`, `notes`, `tags`, `lead_tags`, `property_tags`, `hoa_documents`; enum `water_source_type`. Migrations in [supabase/migrations](supabase/migrations); seeds in [supabase/sql/002_seed_risk_registry.sql](supabase/sql/002_seed_risk_registry.sql).
- **RLS/Identity**: All queries scoped by `agent_id`; functions must use service role key. Client/anon keys should observe RLS when curling.
- **vapi-handler**: Requires `phoneNumberId`; missing mapping → courteous fallback. Auto-lead insert if phone not found; sends Discord if configured. Solar keywords insert lightweight `risk_assessments` row + Solar Liability script. See [supabase/functions/vapi-handler/index.ts](supabase/functions/vapi-handler/index.ts) and [TESTING.md](TESTING.md).
- **Orchestrator**: [supabase/functions/vapi-mcp-server/index.ts](supabase/functions/vapi-mcp-server/index.ts) implements `risk_assessment.create/latest`, `note.create`, `tags.ensure_and_attach`, proxies water/HOA/OCR; auto-upserts lead/property when IDs absent.
- **Solar OCR**: [supabase/functions/solar-ocr-scanner/index.ts](supabase/functions/solar-ocr-scanner/index.ts) now uses Gemini 1.5 Flash Vision (URL or base64). Extracts payment/escalator/buyout/transfer/term/contract/vendor, writes `risk_assessments`, risk=high if escalator>2% or payment>300. Secrets: `GOOGLE_GENERATIVE_AI_KEY`, `SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`. Gaps: no retry/timeout, coarse regex fallback, no URL allowlist.
- **Water**: [supabase/functions/adwr-lookup/index.ts](supabase/functions/adwr-lookup/index.ts) stubbed bounding boxes; production should use ADWR ArcGIS polygons and return `source_layer/confidence`.
- **HOA RAG**: [supabase/functions/hoa-rag/index.ts](supabase/functions/hoa-rag/index.ts) answers rental restriction queries from `hoa_documents`; embeddings/pgvector not wired yet.
- **Webhook util**: HMAC example in [supabase/functions/vapi-mcp-server/vapi-webhook.js](supabase/functions/vapi-mcp-server/vapi-webhook.js).
- **Seeding**: [real-estate-seed](real-estate-seed) — copy `.env.example`→`.env`, set `SUPABASE_URL`/`SUPABASE_SERVICE_ROLE_KEY`, set `VAPI_PHONE_ID` in [real-estate-seed/seed.js](real-estate-seed/seed.js), run `npm run seed`.
- **Local DB & funcs**: `supabase start`; `supabase db reset` + migrations + [supabase/sql/002_seed_risk_registry.sql](supabase/sql/002_seed_risk_registry.sql). Dev: curl `http://127.0.0.1:54321/functions/v1/vapi-mcp-server`; OCR via `/solar-ocr-scanner`; Vapi handler via `deno run --allow-all supabase/functions/vapi-handler/index.ts` then `./test-handler.ps1`.
- **Deploy**: `npx supabase functions deploy <name> --no-verify-jwt`; set secrets `npx supabase secrets set KEY=VALUE`; logs `npx supabase functions logs <name>`; migrations `npx supabase db push --include-all`.
- **Testing vectors**: See curls in [DEVELOPER_HANDOFF.md](DEVELOPER_HANDOFF.md), [supabase/risk-registry.md](supabase/risk-registry.md); solar scenarios in [OCR_PIPELINE_COMPLETE.md](OCR_PIPELINE_COMPLETE.md).
- **Conventions**: Deno Edge; prefer `json()` helpers; actions return `{ ok: true, ... }` or `{ error }` with HTTP 400/500; HMAC optional unless `VAPI_WEBHOOK_SECRET` set.
- **Known gaps**: ADWR stub; solar OCR missing retries/timeout/URL allowlist; no auto-tagging on solar risk; HOA RAG lacks embeddings; PPA/loan classification depends on `contract_type` extraction.
- **Persona**: Keep Spanglish persona + solar/water advisory baked in vapi-handler prompts unless explicitly changed.
- **Patterns**: When adding actions, mirror `vapi-mcp-server` switch, validate required IDs early, keep response shape `{ ok, <payload> }` for compatibility.
